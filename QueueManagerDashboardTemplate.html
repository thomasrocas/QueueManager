<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RCM Dashboard Chart.js</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
    .sidebar {
      width: 137px;
      background: #f4f4f4;
      padding: 10px;
      transition: width 0.3s ease;
      position: relative;
    }
    .sidebar.collapsed { width: 44px; }
    .toggle-arrow {
      position: absolute;
      top: 15px;
      right: -10px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .sidebar h3 { font-size: 16px; margin-bottom: 20px; }
    .sidebar.collapsed h3,
    .sidebar.collapsed .menu-text { display: none; }
    .menu-item { display: flex; align-items: center; padding: 10px; margin: 5px 0; cursor: pointer; border-radius: 5px; }
    .menu-item:hover,
    .menu-item.active { background-color: #dceeff; }
    .menu-item i { margin-right: 10px; }
    .main-content {
      flex: 1;
      padding: 24px 36px;
      overflow-y: auto;
      background: #fff;
    }
    #dashboard {
      max-width: 1350px;
      margin: 0 auto;
    }
    .dashboard-title {
      font-size: 2.1em;
      font-weight: bold;
      margin-bottom: 24px;
      color: #0066bb;
      letter-spacing: 0.01em;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 28px;
      margin-bottom: 36px;
    }
    .chart-card {
      background: #f9fbfc;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      padding: 24px 20px 16px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 320px;
    }
    .chart-title {
      font-size: 1.12em;
      font-weight: bold;
      color: #34495e;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
      text-align: center;
    }
    #data-table {
      margin-top: 18px;
      border-radius: 14px;
      overflow-x: auto;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
      background: #f9fbfc;
      padding: 18px;
    }
    #data-table table {
      border-collapse: collapse;
      width: 100%;
      background: transparent;
      font-size: 0.98em;
    }
    #data-table th, #data-table td {
      border: 1px solid #e4e4e4;
      padding: 8px 14px;
      text-align: left;
    }
    #data-table th {
      background: #f0f5fa;
      font-weight: 700;
    }
    #data-table tr:nth-child(even) {
      background: #f8fafc;
    }
    .filter-label {
      font-size: 1em;
      margin-bottom: 4px;
      color: #007bff;
      font-weight: 500;
    }
    .right-panel-toggle {
      position: fixed;
      top: 50%;
      right: 0;
      width: 30px;
      height: 60px;
      background-color: white;
      color: #007bff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
      z-index: 999;
    }
    .right-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 200px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 998;
      padding: 20px;
    }
    .right-panel.open { right: 0; }
    @media (max-width: 900px) {
      .charts-grid { grid-template-columns: 1fr; }
      .main-content { padding: 16px; }
      .right-panel { width: 98vw; }
    }
  </style>
</head>
<body>
  <!-- Left Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="toggle-arrow" onclick="toggleSidebar()">‚Äπ</button>

    <h3>RCM System</h3>
   <div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'Dashboard')">üìä <span class="menu-text">Dashboard</span></div><div class="menu-item active" onclick="showDashboardPanel(this)"><i data-feather="trending-up" style="margin-right:6px;"></i><span class="menu-text">AR Dashboard</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'Unbilled Dashboard')"><i data-feather="clock" style="margin-right:6px;"></i><span class="menu-text">Unbilled Dashboard</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'Authorization')"><i data-feather="check-circle" style="margin-right:6px;"></i><span class="menu-text">Authorization</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'Validation')"><i data-feather="alert-circle" style="margin-right:6px;"></i><span class="menu-text">Validation</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'Claims')"><i data-feather="file-text" style="margin-right:6px;"></i><span class="menu-text">Claims</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'UnbilledAR')"><i data-feather="alert-octagon" style="margin-right:6px;"></i><span class="menu-text">UnbilledAR</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'BilledAR')"><i data-feather="dollar-sign" style="margin-right:6px;"></i><span class="menu-text">BilledAR</span></div><div class="menu-item" onclick=" FileMaker.PerformScript('OnClickRCMMenu', 'Queue Manager')"><i data-feather="shuffle" style="margin-right:6px;"></i><span class="menu-text">Queue Manager</span></div><div class="menu-item" onclick="FileMaker.PerformScript('OnClickRCMMenu', 'Settings')"><i data-feather="settings" style="margin-right:6px;"></i><span class="menu-text">Settings</span></div>
    </div>

    <!-- Optional: Add sidebar menu items here -->
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div id="dashboard">
      <div class="dashboard-title">RCM Queue Dashboard</div>
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">Assigned To Distribution</div>
          <canvas id="assignedToChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Status Breakdown</div>
          <canvas id="statusChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Priority Trend</div>
          <canvas id="priorityChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Claims by Payor</div>
          <canvas id="payorChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">High Priority Claims</div>
          <canvas id="highPriorityChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Overdue Claims</div>
          <canvas id="overdueChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Claims by Parent Unit</div>
          <canvas id="parentUnitChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Due Date Trend</div>
          <canvas id="dueDateTrendChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Claims Due This Week</div>
          <canvas id="dueDateThisWeekChart"></canvas>
        </div>
        <div class="chart-card">
          <div class="chart-title">Queue Aging</div>
          <canvas id="queueAgingChart"></canvas>
        </div>
      </div>
      <div id="data-table">
        <div class="filter-label">Details Table (Filtered):</div>
        <table>
          <thead>
            <tr>
              <th>Queue ID</th>
              <th>Patient</th>
              <th>Payor Name</th>
              <th>Parent Unit</th>
              <th>Priority</th>
              <th>Status</th>
              <th>RFNP</th>
              <th>subRFNP</th>
              <th>Assigned To</th>
              <th>Admin</th>
              <th>Due Date</th>
              <th>Event Date</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Right Sidebar Toggle Button -->
  <div class="right-panel-toggle" onclick="toggleRightPanel()">‚ùØ</div>
  <!-- Right Sidebar Panel -->
  <div class="right-panel" id="rightPanel">
    <h2>Right Panel</h2>
    <p>
      This right panel matches your SettingsTemplate.<br>
      You can place any content here (settings, logs, etc).<br>
      Edit the <code>#rightPanel</code> div as needed!
    </p>
  </div>

  <script>
    // Left sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
    }
    // Right panel toggle
    function toggleRightPanel() {
      const panel = document.getElementById('rightPanel');
      panel.classList.toggle('open');
    }

    let zoomLevel = 1;
    function applyZoom() {
      const dash = document.getElementById('data-table');
      dash.style.transform = `scale(${zoomLevel})`;
      dash.style.transformOrigin = '0 0';
    }
    function zoomIn() {
      zoomLevel = Math.min(2, zoomLevel + 0.1);
      applyZoom();
    }
    function zoomOut() {
      zoomLevel = Math.max(0.5, zoomLevel - 0.1);
      applyZoom();
    }

    // ---- SAMPLE DATA (Replace with your actual JSON!) ----
    const rawData = [
     {"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"106851_75349_250521250618","DueDate":"8/25/2025","Event Date":"5/21/2025 - 6/18/2025","MRN":"1068514","Parent Unit":"Home Health","Patient":"Warren, Sy","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:14 AM","QueueID":"A824C9E5-092B-CD45-8A04-FA657A9F1CC3","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Karen Torres","ClaimID":"109310_76578_250530250627","DueDate":"7/4/2025","Event Date":"5/30/2025 - 6/27/2025","MRN":"1093105","Parent Unit":"Home Health","Patient":"Crivello, qu F.","Payor Name":"Medicare PPS","Priority":"High","QueueDate":"7/30/2025 7:47:14 AM","QueueID":"15DA04FC-7F35-F941-98A0-7F61A3E94A31","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"109258_76640_250501250528","DueDate":"8/1/2025","Event Date":"5/1/2025 - 5/28/2025","MRN":"1092583","Parent Unit":"Home Health","Patient":"Zuniga, ar A.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:15 AM","QueueID":"8EB650BF-267E-AD41-B3B8-E68EEAE50010","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Von Lumanog","ClaimID":"106851_75349_250521250618","DueDate":"6/3/2025","Event Date":"5/21/2025 - 6/18/2025","MRN":"1068514","Parent Unit":"Home Health","Patient":"Warren, as","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:48 AM","QueueID":"82DCFC4D-10B3-A24D-90D8-70BA8DF848C5","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Lisa Mangubat","ClaimID":"109310_76578_250530250627","DueDate":"8/5/2025","Event Date":"5/30/2025 - 6/27/2025","MRN":"1093102","Parent Unit":"Home Health","Patient":"Crivello, gdf F.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:49 AM","QueueID":"0007F76E-398C-CB4E-AF42-1020C895F61C","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"109258_76640_250501250528","DueDate":"8/25/2025","Event Date":"5/1/2025 - 5/28/2025","MRN":"1092581","Parent Unit":"Home Health","Patient":"Zuniga, sd A.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:49 AM","QueueID":"80085768-C33D-3E44-A6B0-15FC2BF56EFB","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"110046_76583_250602250630","DueDate":"7/24/2025","Event Date":"6/2/2025 - 6/30/2025","MRN":"1100462","Parent Unit":"Home Health","Patient":"McCauley, fer E.","Payor Name":"Medicare PPS","Priority":"High","QueueDate":"7/30/2025 7:47:50 AM","QueueID":"C82B2E31-6884-144D-824C-0DEFDCCE8825","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Faye Dominguez","ClaimID":"111796_76591_250623250721","DueDate":"8/25/2025","Event Date":"6/23/2025 - 7/21/2025","MRN":"1117962","Parent Unit":"Home Health","Patient":"Hunsg, as C.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:50 AM","QueueID":"EE84F3CA-1D3C-A742-8E7E-BD7070F3D7E4","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111867_76590_250617250702","DueDate":"1/15/2025","Event Date":"6/17/2025 - 7/2/2025","MRN":"1118671","Parent Unit":"Home Health","Patient":"dsdfd, Judith A.","Payor Name":"Medicare PPS","Priority":"Medium","QueueDate":"7/30/2025 7:47:51 AM","QueueID":"3B71A266-A004-2D48-9958-7D8E47047BFE","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111869_76584_250605250611","DueDate":"8/25/2025","Event Date":"6/5/2025 - 6/11/2025","MRN":"1118692","Parent Unit":"Home Health","Patient":"Sandxdcoval, Gricelda C.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:51 AM","QueueID":"6C7B6CE2-C03B-884C-A4F2-CD7040540A1F","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"104748_76565_250606250701","DueDate":"8/25/2025","Event Date":"6/6/2025 - 7/1/2025","MRN":"1047481","Parent Unit":"Home Health","Patient":"tr, Lilly L.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:52 AM","QueueID":"90CCAF67-4DC3-3541-9E24-C8B0ABD3451C","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"110561_76586_250617250714","DueDate":"6/14/2025","Event Date":"6/17/2025 - 7/14/2025","MRN":"1105617","Parent Unit":"Home Health","Patient":"fer, Kelly P.","Payor Name":"BTMG","Priority":"High","QueueDate":"7/26/2025 7:47:52 AM","QueueID":"9876BC47-A1A5-344E-935A-D81DD64D5F3A","RFNP":"","SourceTable":"BilledAR","Status":"RFNP","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111925_76585_250614250708","DueDate":"8/25/2025","Event Date":"6/14/2025 - 7/8/2025","MRN":"1119253","Parent Unit":"Home Health","Patient":"a sd, Bula R.","Payor Name":"UHC","Priority":"Low","QueueDate":"7/30/2025 7:47:53 AM","QueueID":"CE543FB2-4B08-4F4F-B218-B986D8EA0029","RFNP":"","SourceTable":"BilledAR","Status":"Write-Off","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111619_76580_250613250619","DueDate":"8/25/2025","Event Date":"6/13/2025 - 6/19/2025","MRN":"1116319","Parent Unit":"Home Health","Patient":"rger, Satya P.","Payor Name":"Kaiser","Priority":"Medium","QueueDate":"7/30/2025 7:47:53 AM","QueueID":"F4642B44-8387-874B-9C7C-F96238023844","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111510_76588_250604250703","DueDate":"8/25/2025","Event Date":"6/4/2025 - 7/3/2025","MRN":"1115130","Parent Unit":"Home Health","Patient":"werew, Penelope M.","Payor Name":"Medicare PPS","Priority":"High","QueueDate":"7/30/2025 7:47:54 AM","QueueID":"99581213-4737-6F4C-B943-76755BC3E06E","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"100314_76589_250621250714","DueDate":"8/25/2025","Event Date":"6/21/2025 - 7/14/2025","MRN":"10032114","Parent Unit":"Home Health","Patient":"wer, Dorothy A.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:54 AM","QueueID":"62714537-F893-2D4F-BDFE-1208A31460CE","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"201791_4892_250609250703","DueDate":"8/25/2025","Event Date":"6/9/2025 - 7/3/2025","MRN":"2017911","Parent Unit":"Home Health","Patient":"wer, Richard E.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:55 AM","QueueID":"98331F16-30FC-5942-97FD-74E42A0B6B37","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"108816_76643_250610250708","DueDate":"8/25/2025","Event Date":"6/10/2025 - 7/8/2025","MRN":"1088216","Parent Unit":"Home Health","Patient":"wer, Jose O.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:47:55 AM","QueueID":"6A9193CC-22E3-4F48-8B85-DEFF711B97C0","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"110272_76587_250616250711","DueDate":"8/25/2025","Event Date":"6/16/2025 - 7/11/2025","MRN":"1102372","Parent Unit":"Home Health","Patient":"wer, Dorothy F.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/15/2025 7:47:56 AM","QueueID":"2C66F078-6E44-C74F-8895-43334E2EC307","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111486_76642_250630250724","DueDate":"7/26/2025","Event Date":"6/30/2025 - 7/24/2025","MRN":"1114846","Parent Unit":"Home Health","Patient":"Pfefsvsdffer, Amy J.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/30/2025 7:48:47 AM","QueueID":"9E05482C-6090-BC49-86BD-ECB5FDDF462F","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""},
{"Admin":"","AssignedTo":"Cristina Del Rosario","ClaimID":"111579_76644_250703250723","DueDate":"8/25/2025","Event Date":"7/3/2025 - 7/23/2025","MRN":"1115794","Parent Unit":"Home Health","Patient":"Showwefwaihat, Asma Y.","Payor Name":"Medicare PPS","Priority":"Low","QueueDate":"7/1/2025 7:48:48 AM","QueueID":"9D144AB6-56A5-B344-95D2-07E3A10BE156","RFNP":"","SourceTable":"BilledAR","Status":"Billed","subRFNP":""}
    ];
    let currentFilter = {};

    function assignedToData(data) {
      let count = {};
      data.forEach(d => {
        let key = d.AssignedTo ? d.AssignedTo : '(Unassigned)';
        count[key] = (count[key]||0) + 1;
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function statusData(data) {
      let count = {};
      data.forEach(d => {
        let key = d.Status ? d.Status : '(No Status)';
        count[key] = (count[key]||0) + 1;
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function priorityData(data) {
      let count = {};
      data.forEach(d => {
        let key = d.Priority ? d.Priority : '(None)';
        count[key] = (count[key]||0) + 1;
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function payorData(data) {
      let count = {};
      data.forEach(d => {
        let key = d["Payor Name"] ? d["Payor Name"] : '(Unknown)';
        count[key] = (count[key]||0) + 1;
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function highPriorityByAssignedTo(data) {
      let count = {};
      data.forEach(d => {
        if (d.Priority === 'High') {
          let key = d.AssignedTo ? d.AssignedTo : '(Unassigned)';
          count[key] = (count[key] || 0) + 1;
        }
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function overdueVsDueThisWeek(data) {
      let today = new Date();
      let startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      startOfWeek.setHours(0,0,0,0);
      let endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      let count = { overdue: 0, "due this week": 0 };
      data.forEach(d => {
        let due = new Date(d.DueDate);
        if (isNaN(due)) return;
        if (due < today) {
          count.overdue++;
        } else if (due >= startOfWeek && due <= endOfWeek) {
          count["due this week"]++;
        }
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function parentUnitData(data) {
      let count = {};
      data.forEach(d => {
        let key = d["Parent Unit"]  ? d["Parent Unit"]  : '(Unknown)';
        count[key] = (count[key] || 0) + 1;
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function dueDateTrendData(data) {
      let count = {};
      data.forEach(d => {
        let due = new Date(d.DueDate);
        if (isNaN(due)) return;
        let weekLabel = getWeekLabel(due);
        count[weekLabel] = (count[weekLabel] || 0) + 1;
      });
      return {
        labels: Object.keys(count),
        values: Object.values(count)
      };
    }
    function dueDateThisWeekData(data) {
      let today = new Date();
      let startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - today.getDay());
      startOfWeek.setHours(0,0,0,0);
      let endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6);
      let days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      let count = { Sun:0, Mon:0, Tue:0, Wed:0, Thu:0, Fri:0, Sat:0 };
      data.forEach(d => {
        let due = new Date(d.DueDate);
        if (isNaN(due)) return;
        if (due >= startOfWeek && due <= endOfWeek) {
          let label = days[due.getDay()];
          count[label] = (count[label] || 0) + 1;
        }
      });
      return {
        labels: days,
        values: days.map(day => count[day])
      };
    }
    function queueAgingData(data) {
      let today = new Date();
      let buckets = { '0-7': 0, '8-14': 0, '15-30': 0, '31-60': 0, '60+': 0 };
      data.forEach(d => {
        if (!d.QueueDate) return;
        let qDateStr = d.QueueDate.split('-')[0].trim();
        let qDate = new Date(qDateStr);
        if (isNaN(qDate)) qDate = new Date(d.QueueDate);
        if (isNaN(qDate)) return;
        let diff = Math.floor((today - qDate) / 86400000);
        if (diff <= 7) buckets['0-7']++;
        else if (diff <= 14) buckets['8-14']++;
        else if (diff <= 30) buckets['15-30']++;
        else if (diff <= 60) buckets['31-60']++;
        else buckets['60+']++;
      });
      return {
        labels: Object.keys(buckets),
        values: Object.values(buckets)
      };
    }
    function getWeekLabel(date) {
      let year = date.getFullYear();
      let firstDay = new Date(year, 0, 1);
      let days = Math.floor((date - firstDay) / 86400000);
      let week = Math.ceil((days + firstDay.getDay() + 1) / 7);
      return `${year}-W${week}`;
    }
    function renderTable(data) {
      const rows = data.map(d => [
        d.QueueID,
        d.Patient || "",
        d["Payor Name"] || "",
        d["Parent Unit"] || "",
        d.Priority || "",
        d.Status || "",
        d.RFNP || "",
        d.subRFNP || "",
        d.AssignedTo || "",
        d.Admin || "",
        d.DueDate || "",
        d["Event Date"] || ""
      ]);
      if (table) {
        table.clear().rows.add(rows).draw();
      } else {
        let html = rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('');
        $("#tableBody").html(html);
      }
    }
    function filterData() {
      let data = rawData;
      Object.entries(currentFilter).forEach(([field, value]) => {
        data = data.filter(d => {
          if (field === 'OverdueStatus') {
            let due = new Date(d.DueDate);
            if (isNaN(due)) return false;
            let today = new Date();
            let startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0,0,0,0);
            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            if (value === 'overdue') return due < today;
            if (value === 'due this week') return due >= startOfWeek && due <= endOfWeek;
            return false;
          } else if (field === 'DueDateWeek') {
            let due = new Date(d.DueDate);
            if (isNaN(due)) return false;
            return getWeekLabel(due) === value;
          } else if (field === 'DueDateDay') {
            let due = new Date(d.DueDate);
            if (isNaN(due)) return false;
            let days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            return days[due.getDay()] === value;
          } else if (field === 'QueueAgeRange') {
            if (!d.QueueDate) return false;
            let qDateStr = d.QueueDate.split('-')[0].trim();
            let qDate = new Date(qDateStr);
            if (isNaN(qDate)) qDate = new Date(d.QueueDate);
            if (isNaN(qDate)) return false;
            let diff = Math.floor((new Date() - qDate) / 86400000);
            let bucket;
            if (diff <= 7) bucket = '0-7';
            else if (diff <= 14) bucket = '8-14';
            else if (diff <= 30) bucket = '15-30';
            else if (diff <= 60) bucket = '31-60';
            else bucket = '60+';
            return bucket === value;
          } else {
            return (d[field] || '') === value;
          }
        });
      });
      return data;
    }
    function updateAllCharts() {
      let data = filterData();
      let aData = assignedToData(data);
      assignedToChart.data.labels = aData.labels;
      assignedToChart.data.datasets[0].data = aData.values;
      assignedToChart.update();
      let sData = statusData(data);
      statusChart.data.labels = sData.labels;
      statusChart.data.datasets[0].data = sData.values;
      statusChart.update();
      let pData = priorityData(data);
      priorityChart.data.labels = pData.labels;
      priorityChart.data.datasets[0].data = pData.values;
      priorityChart.update();
      let payData = payorData(data);
      payorChart.data.labels = payData.labels;
      payorChart.data.datasets[0].data = payData.values;
      payorChart.update();
      let hpData = highPriorityByAssignedTo(data);
      highPriorityChart.data.labels = hpData.labels;
      highPriorityChart.data.datasets[0].data = hpData.values.map((v, i) => ({ x: i, y: v, r: Math.max(5, v * 3) }));
      highPriorityChart.options.scales.x.ticks.callback = function(value) { return hpData.labels[value]; };
      highPriorityChart.update();
      let odData = overdueVsDueThisWeek(data);
      overdueChart.data.labels = odData.labels;
      overdueChart.data.datasets[0].data = odData.values;
      overdueChart.update();
      let puData = parentUnitData(data);
      parentUnitChart.data.labels = puData.labels;
      parentUnitChart.data.datasets[0].data = puData.values;
      parentUnitChart.update();
      let trendData = dueDateTrendData(data);
      dueDateTrendChart.data.labels = trendData.labels;
      dueDateTrendChart.data.datasets[0].data = trendData.values;
      dueDateTrendChart.update();
      let weekData = dueDateThisWeekData(data);
      dueDateThisWeekChart.data.labels = weekData.labels;
      dueDateThisWeekChart.data.datasets[0].data = weekData.values;
      dueDateThisWeekChart.update();
      let agingData = queueAgingData(data);
      queueAgingChart.data.labels = agingData.labels;
      queueAgingChart.data.datasets[0].data = agingData.values;
      queueAgingChart.update();
      renderTable(data);
    }

    let assignedToChart, statusChart, priorityChart, payorChart,
        highPriorityChart, overdueChart, parentUnitChart,
        dueDateTrendChart, dueDateThisWeekChart, queueAgingChart,
        table;
    $(function() {
      feather.replace();
      let aData = assignedToData(rawData);
      assignedToChart = new Chart($("#assignedToChart"), {
        type: 'bar',
        data: {
          labels: aData.labels,
          datasets: [{
            label: '# Claims',
            data: aData.values,
            backgroundColor: 'rgba(0, 123, 255, 0.6)'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { AssignedTo: label === "(Unassigned)" ? "" : label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: {
            legend: { display: false }
          },
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      let sData = statusData(rawData);
      statusChart = new Chart($("#statusChart"), {
        type: 'doughnut',
        data: {
          labels: sData.labels,
          datasets: [{
            label: '# Claims',
            data: sData.values,
            backgroundColor: [
              '#0d6efd', '#6c757d', '#198754', '#ffc107', '#dc3545', '#adb5bd'
            ]
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { Status: label === "(No Status)" ? "" : label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { position: 'bottom' } },
          cutout: "65%"
        }
      });

      let pData = priorityData(rawData);
      priorityChart = new Chart($("#priorityChart"), {
        type: 'bar',
        data: {
          labels: pData.labels,
          datasets: [{
            label: '# Claims',
            data: pData.values,
            backgroundColor: 'rgba(253, 126, 20, 0.7)'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { Priority: label === "(None)" ? "" : label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: {
            legend: { display: false }
          },
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      let payData = payorData(rawData);
      payorChart = new Chart($("#payorChart"), {
        type: 'pie',
        data: {
          labels: payData.labels,
          datasets: [{
            label: '# Claims',
            data: payData.values,
            backgroundColor: [
              '#007bff','#6610f2','#6f42c1','#d63384','#fd7e14','#ffc107','#28a745','#20c997'
            ]
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { "Payor Name": label === "(Unknown)" ? "" : label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { position: 'bottom' } }
        }
      });

      let hpData = highPriorityByAssignedTo(rawData);
      highPriorityChart = new Chart($("#highPriorityChart"), {
        type: 'bubble',
        data: {
          labels: hpData.labels,
          datasets: [{
            label: '# High Priority',
            data: hpData.values.map((v, i) => ({ x: i, y: v, r: Math.max(5, v * 3) })),
            backgroundColor: 'rgba(220, 53, 69, 0.7)'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = hpData.labels[items[0].index];
              currentFilter = { AssignedTo: label === "(Unassigned)" ? "" : label, Priority: "High" };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { display: false } },
          responsive: true,
          scales: {
            x: {
              ticks: {
                callback: function(value) { return hpData.labels[value]; }
              }
            },
            y: { beginAtZero: true }
          }
        }
      });

      let odData = overdueVsDueThisWeek(rawData);
      overdueChart = new Chart($("#overdueChart"), {
        type: 'doughnut',
        data: {
          labels: odData.labels,
          datasets: [{
            label: '# Claims',
            data: odData.values,
            backgroundColor: ['#dc3545', '#ffc107']
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { OverdueStatus: label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { position: 'bottom' } },
          cutout: '65%'
        }
      });

      let puData = parentUnitData(rawData);
      parentUnitChart = new Chart($("#parentUnitChart"), {
        type: 'bar',
        data: {
          labels: puData.labels,
          datasets: [{
            label: '# Claims',
            data: puData.values,
            backgroundColor: 'rgba(40, 167, 69, 0.6)'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { "Parent Unit": label === "(Unknown)" ? "" : label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { display: false } },
          responsive: true,
          indexAxis: 'y',
          scales: { x: { beginAtZero: true } }
        }
      });

      let trendData = dueDateTrendData(rawData);
      dueDateTrendChart = new Chart($("#dueDateTrendChart"), {
        type: 'line',
        data: {
          labels: trendData.labels,
          datasets: [{
            label: '# Claims',
            data: trendData.values,
            fill: false,
            borderColor: '#007bff'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { DueDateWeek: label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { display: false } },
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      let weekData = dueDateThisWeekData(rawData);
      dueDateThisWeekChart = new Chart($("#dueDateThisWeekChart"), {
        type: 'bar',
        data: {
          labels: weekData.labels,
          datasets: [{
            label: '# Claims',
            data: weekData.values,
            backgroundColor: 'rgba(23, 162, 184, 0.6)'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { DueDateDay: label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { display: false } },
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      let agingData = queueAgingData(rawData);
      queueAgingChart = new Chart($("#queueAgingChart"), {
        type: 'bar', // histogram representation
        data: {
          labels: agingData.labels,
          datasets: [{
            label: '# Claims',
            data: agingData.values,
            backgroundColor: 'rgba(108, 117, 125, 0.6)'
          }]
        },
        options: {
          onClick: function(e, items) {
            if(items.length) {
              const label = this.data.labels[items[0].index];
              currentFilter = { QueueAgeRange: label };
            } else {
              currentFilter = {};
            }
            updateAllCharts();
          },
          plugins: { legend: { display: false } },
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });

      renderTable(rawData);
      table = $('#data-table table').DataTable({
        scrollX: true,
        scrollY: '400px',
        paging: true,
        ordering: true,
        lengthMenu: [10, 25, 50, 100],
        dom: 'Bfrtip',
        buttons: [
          { extend: 'excel', text: feather.icons["download"].toSvg() },
          { extend: 'csv', text: feather.icons["file-text"].toSvg() },
          { text: feather.icons["zoom-in"].toSvg(), action: function(){ zoomIn(); } },
          { text: feather.icons["zoom-out"].toSvg(), action: function(){ zoomOut(); } },
          'colvis'
        ]
      });
      feather.replace();
      applyZoom();
    });
  </script>
</body>
</html>
